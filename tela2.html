<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produtos Dispon√≠veis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card:hover {
      transform: scale(1.05);
      transition: transform 0.3s ease;
    }

    #contadorCarrinho {
      transition: all 0.3s ease;
    }
    #contadorCarrinho.pulse {
      transform: scale(1.3);
      background-color: #2563eb;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // üî• MESMA CONFIGURA√á√ÉO DO CRUD
    const firebaseConfig = {
        apiKey: "AIzaSyAlzXt2nCQOeoVic2K-oOHlMXeLKOrWT20",
        authDomain: "crdu-c8441.firebaseapp.com",
        projectId: "crdu-c8441",
        storageBucket: "crdu-c8441.firebasestorage.app",
        messagingSenderId: "786542956519",
        appId: "1:786542956519:web:4c59611ee100125b17b742"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const produtosRef = collection(db, "produtos");

    let produtos = [];
    let carrinho = [];

    // Renderizar produtos
    function renderizarProdutos(lista) {
      const grid = document.getElementById("listaProdutos");
      grid.innerHTML = "";

      lista.forEach((produto) => {
        const card = document.createElement("div");
        card.className = "card fade-in bg-white rounded-2xl shadow-lg p-5 border border-gray-100 flex flex-col justify-between";

        card.innerHTML = `
          <h2 class="text-lg font-semibold text-blue-700 mb-2">${produto.nome}</h2>
          <p class="text-gray-600"><strong>Pre√ßo:</strong> R$ ${produto.preco.toFixed(2)}</p>
          <p class="text-gray-600 mb-3"><strong>Quantidade:</strong> ${produto.quantidade}</p>
          <button 
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" 
            onclick="adicionarAoCarrinho('${produto.nome}', ${produto.preco}, ${produto.quantidade})"
            ${produto.quantidade === 0 ? "disabled" : ""}>
            üõí Adicionar
          </button>
        `;
        grid.appendChild(card);
      });
    }

    // Escuta em tempo real
    onSnapshot(produtosRef, (snapshot) => {
      produtos = [];
      snapshot.forEach((doc) => {
        produtos.push(doc.data());
      });
      renderizarProdutos(produtos);
    });

    // Buscar e filtrar
    window.buscar = function () {
      const termo = document.getElementById("busca").value.toLowerCase();
      const precoFiltro = parseFloat(document.getElementById("filtroPreco").value);
      const filtrados = produtos.filter((p) => {
        const nomeMatch = p.nome.toLowerCase().includes(termo);
        const precoMatch = isNaN(precoFiltro) || p.preco <= precoFiltro;
        return nomeMatch && precoMatch;
      });
      renderizarProdutos(filtrados);
    };

    // Adicionar ao carrinho com controle de estoque
    window.adicionarAoCarrinho = function(nome, preco, estoque) {
      const item = carrinho.find((p) => p.nome === nome);
      if (item) {
        if (item.quantidade < estoque) {
          item.quantidade++;
        } else {
          alert("‚ö†Ô∏è Estoque esgotado para este produto!");
          return;
        }
      } else {
        carrinho.push({ nome, preco, quantidade: 1, estoque });
      }
      atualizarCarrinho();
    };

    // Remover item do carrinho
    window.removerDoCarrinho = function(nome) {
      const item = carrinho.find((p) => p.nome === nome);
      if (!item) return;

      item.quantidade--;
      if (item.quantidade <= 0) {
        carrinho = carrinho.filter((p) => p.nome !== nome);
      }
      atualizarCarrinho();
    };

    // Atualizar visual do carrinho
    function atualizarCarrinho() {
      const contador = document.getElementById("contadorCarrinho");
      contador.textContent = carrinho.reduce((acc, item) => acc + item.quantidade, 0);

      contador.classList.add("pulse");
      setTimeout(() => contador.classList.remove("pulse"), 300);

      const listaCarrinho = document.getElementById("itensCarrinho");
      listaCarrinho.innerHTML = "";

      let total = 0;
      carrinho.forEach((item) => {
        total += item.preco * item.quantidade;

        const li = document.createElement("li");
        li.className = "flex justify-between items-center text-gray-700 border-b py-2";

        li.innerHTML = `
          <span class="font-medium">${item.nome} (x${item.quantidade})</span>
          <div class="flex items-center gap-2">
            <span>R$ ${(item.preco * item.quantidade).toFixed(2)}</span>
            <button onclick="removerDoCarrinho('${item.nome}')" class="text-red-500 hover:text-red-700 font-bold px-2">‚àí</button>
          </div>
        `;
        listaCarrinho.appendChild(li);
      });

      document.getElementById("totalCarrinho").textContent = `Total: R$ ${total.toFixed(2)}`;
    }

  </script>
</head>

<body class="bg-gradient-to-br from-blue-100 via-gray-100 to-white min-h-screen p-6">
  <div class="max-w-6xl mx-auto fade-in">
    
    <!-- Cabe√ßalho -->
    <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-blue-700 mb-4 sm:mb-0">üõçÔ∏è Produtos Dispon√≠veis</h1>

      <!-- Carrinho -->
      <div class="relative flex items-center">
        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-md hover:bg-blue-700 transition">
          üõí Carrinho 
          <span id="contadorCarrinho" class="ml-2 bg-white text-blue-700 font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span>
        </button>
      </div>
    </header>

    <!-- Filtros -->
    <div class="flex flex-col sm:flex-row gap-4 mb-8">
      <input id="busca" oninput="buscar()" type="text" placeholder="üîç Buscar produto..." class="border border-gray-300 p-2 rounded-lg w-full sm:w-1/2 focus:ring focus:ring-blue-200">
      <input id="filtroPreco" oninput="buscar()" type="number" placeholder="Filtrar por pre√ßo m√°ximo" step="0.01" class="border border-gray-300 p-2 rounded-lg w-full sm:w-1/2 focus:ring focus:ring-blue-200">
    </div>

    <!-- Produtos -->
    <div id="listaProdutos" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

    <!-- Carrinho -->
    <div class="mt-10 bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
      <h2 class="text-2xl font-semibold text-blue-700 mb-4">üßæ Seu Carrinho</h2>
      <ul id="itensCarrinho" class="space-y-2 mb-4"></ul>
      <p id="totalCarrinho" class="text-lg font-bold text-gray-700">Total: R$ 0,00</p>
    </div>

  </div>
</body>
</html>
